<script>
var list = [
  {{ range sort .Site.Data.channels "name" "asc" }}
    {
      'name': "{{ .name }}",
      'slug': "{{ .slug }}",
      'tags': {{ .tags }},
      'description': {{ .description }},
    },
  {{ end }}
]
var options = {
  shouldSort: true,
  threshold: 0.4,
  location: 0,
  distance: 100,
  maxPatternLength: 32,
  minMatchCharLength: 1,
  id: "slug",
  keys: [
    "name", "slug", "tags", "description"
  ]
};
var fuse = new Fuse(list, options);
var search = document.getElementById("search");
var list = document.getElementsByClassName("list")[0];
var items = list.children;

function listSearch(query) {
  var baseUrl = window.location.href;
  var search = document.getElementById("search");
  var results = fuse.search(query);

  list.classList.toggle('searching', query.length > 0);
  for (var i = 0; i < items.length; i++) {
    var item = items[i];
    item.classList.toggle('found', results.indexOf(item.id) > -1);
  }
}

function setSearch(query) {
  if(query && query.length > 0) {
    search.value = query.replace("%20"," ");
    listSearch(query);
  }
}

search.addEventListener("keyup", function() {
  var query = this.value;
  listSearch(query);

  history.replaceState(window.history.state,{},'?q=' + query.toLowerCase());
});

window.addEventListener("DOMContentLoaded", function(e) {
  let searchParams = new URLSearchParams(window.location.search);
  let query = searchParams.get('q');

  setSearch(query);

  search.focus();
  search.value = search.value;
});

search.addEventListener("search", function(e) {
  list.classList.toggle('searching');
  for (var i = 0; i < items.length; i++) {
    var item = items[i];
    item.classList.remove("found");
  }
  window.location.href = window.location.origin;
})
</script>
